<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flow 1 — Authentication & Onboarding</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #1e293b; background: #f1f5f9; line-height: 1.5; font-size: 14px;
      display: flex; min-height: 100vh;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: 260px; min-width: 260px; background: #fff;
      border-right: 1px solid #e2e8f0;
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
      transition: width .25s, min-width .25s; overflow: hidden;
    }
    .sidebar.collapsed { width: 48px; min-width: 48px; }
    .sidebar-brand {
      padding: 20px 16px 12px; border-bottom: 1px solid #e2e8f0;
      display: flex; align-items: center; gap: 10px; white-space: nowrap; overflow: hidden;
    }
    .sidebar-brand h2 { font-size: 15px; font-weight: 800; color: #0f172a; transition: opacity .2s; }
    .sidebar.collapsed .sidebar-brand h2 { opacity: 0; pointer-events: none; }
    .sidebar-toggle {
      width: 28px; height: 28px; border-radius: 6px; border: 1px solid #e2e8f0;
      background: #f8fafc; cursor: pointer; display: flex; align-items: center;
      justify-content: center; flex-shrink: 0; color: #64748b;
    }
    .sidebar-toggle:hover { background: #e2e8f0; }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 16px;
      color: #475569; font-size: 13px; font-weight: 600; text-decoration: none;
      border-left: 3px solid transparent; transition: all .15s;
      white-space: nowrap; overflow: hidden;
    }
    .nav-item:hover { background: #f8fafc; color: #1e293b; }
    .nav-item.active { background: #eff6ff; color: #1d4ed8; border-left-color: #3b82f6; }
    .nav-dot {
      width: 24px; height: 24px; border-radius: 6px; display: flex;
      align-items: center; justify-content: center;
      color: #fff; font-weight: 800; font-size: 11px; flex-shrink: 0;
    }
    .nav-label { transition: opacity .2s; }
    .sidebar.collapsed .nav-label { opacity: 0; }

    /* ── Main ── */
    .main { flex: 1; margin-left: 260px; padding: 32px 40px; transition: margin-left .25s; }
    .sidebar.collapsed ~ .main { margin-left: 48px; }
    .page-header { margin-bottom: 28px; }
    .page-header h1 { font-size: 26px; font-weight: 800; color: #0f172a; margin-bottom: 4px; }
    .page-header p { color: #64748b; font-size: 14px; }

    /* ── Flow sections ── */
    .flow-section {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      box-shadow: 0 0 2px 0 rgba(145,158,171,.2), 0 12px 24px -4px rgba(145,158,171,.12);
      margin-bottom: 32px; position: relative;
    }
    .section-title {
      font-size: 16px; font-weight: 700; color: #334155; margin: 0 0 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title .badge {
      font-size: 11px; font-weight: 700; color: #fff;
      background: #6366f1; padding: 2px 8px; border-radius: 4px;
    }

    /* ── Diagram viewport ── */
    .diagram-viewport {
      width: 100%; height: 620px; overflow: hidden;
      border-radius: 12px; position: relative;
      cursor: grab; background: #fafbfc;
      border-top: 1px solid #f1f5f9;
    }
    .diagram-viewport:active { cursor: grabbing; }
    .diagram-viewport .mermaid {
      transform-origin: 0 0;
      position: absolute; top: 0; left: 0;
    }

    /* ── Zoom toolbar ── */
    .zoom-toolbar {
      position: absolute; top: 12px; right: 12px; z-index: 10;
      display: flex; flex-direction: column; gap: 0;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08); overflow: hidden;
    }
    .zoom-btn {
      width: 36px; height: 36px; border: none; border-bottom: 1px solid #f1f5f9;
      background: #fff; color: #475569; font-size: 18px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all .12s; line-height: 1;
    }
    .zoom-btn:last-child { border-bottom: none; }
    .zoom-btn:hover { background: #f1f5f9; color: #1e293b; }
    .zoom-btn:active { background: #e2e8f0; }
    .zoom-btn svg { width: 16px; height: 16px; }
    .zoom-btn.text-btn { font-size: 10px; font-weight: 700; letter-spacing: .3px; }
    .zoom-level {
      width: 36px; height: 28px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: #94a3b8; user-select: none;
      border-bottom: 1px solid #f1f5f9; background: #f8fafc;
    }

    footer { text-align: center; padding: 24px 0; color: #94a3b8; font-size: 12px; border-top: 1px solid #e2e8f0; margin-top: 20px; }

    @media (max-width: 768px) {
      .sidebar { width: 48px; min-width: 48px; }
      .sidebar .nav-label { opacity: 0; }
      .sidebar .sidebar-brand h2 { opacity: 0; }
      .main { margin-left: 48px; padding: 16px; }
      .diagram-viewport { height: 450px; }
    }
  </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
      <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
    </button>
    <h2>Flow Diagrams</h2>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="index.html">
      <span class="nav-dot" style="background:#64748b;"><svg width="12" height="12" viewBox="0 0 20 20" fill="#fff"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg></span>
      <span class="nav-label">Legend</span>
    </a>
    <a class="nav-item active" href="flow-1-authentication.html">
      <span class="nav-dot" style="background:#6366f1;">1</span>
      <span class="nav-label">Authentication</span>
    </a>
    <a class="nav-item" href="flow-2-content-creation.html">
      <span class="nav-dot" style="background:#10b981;">2</span>
      <span class="nav-label">Content Creation</span>
    </a>
    <a class="nav-item" href="flow-3-student-practice.html">
      <span class="nav-dot" style="background:#f59e0b;">3</span>
      <span class="nav-label">Student Practice</span>
    </a>
    <a class="nav-item" href="flow-4-school-management.html">
      <span class="nav-dot" style="background:#ef4444;">4</span>
      <span class="nav-label">School Management</span>
    </a>
    <a class="nav-item" href="flow-5-platform-admin.html">
      <span class="nav-dot" style="background:#8b5cf6;">5</span>
      <span class="nav-label">Platform Admin</span>
    </a>
  </nav>
</aside>

<div class="main">
  <div class="page-header">
    <h1>1. Authentication &amp; Onboarding</h1>
    <p>Login page only has Google sign-in. New users complete a profile form to select their role.</p>
  </div>

  <!-- ═══════════ FLOW A: First-time Sign-in ═══════════ -->
  <h3 class="section-title"><span class="badge">A</span> First-time Sign-in</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowA">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowA">
      <pre class="mermaid">
flowchart TD
    A([User opens DAHUA AI]):::start --> B["Login page:<br/>Welcome to DAHUA AI<br/><b>Sign in with Google</b>"]
    B --> BW["WARNING — No alternative login<br/>No Register link / No email-password<br/>Google sign-in is the only option"]:::warn
    BW --> C[User clicks 'Sign in with Google']
    C --> D[Google account picker popup<br/><i>always shows account chooser</i>]
    D --> E{Popup OK?}:::decision

    E -->|Yes| F[Loading screen<br/>DAHUA logo spinner]
    E -->|No| G["WARNING — Silent failure<br/>No error message shown to user"]:::warn
    G --> G1["Popup blocked / closed /<br/>network error — nothing happens on screen"]
    G1 --> G2[User can only retry<br/>the same button]

    F --> H{API OK?}:::decision
    H -->|Yes| I[Redirected to 'Edit User' page]
    H -->|No| J["BLOCKED — Stuck on loading forever<br/>No timeout / No error / No retry"]:::gate
    J --> J1["Logo spinner loops indefinitely<br/>User must manually refresh the page"]

    I --> IW["WARNING — No onboarding guidance<br/>Page title = 'Edit User'<br/>Breadcrumb = Dashboard > User > Edit User<br/>No welcome message or step indicator"]:::warn
    IW --> K["Form fields:<br/>First Name* / Last Name*<br/>Email (disabled, empty)<br/>Phone / Role dropdown<br/>Organization (disabled) / School (disabled)"]

    K --> KW1["WARNING — Email field is blank<br/>Google email not auto-populated<br/>Field is disabled, user cannot type<br/>User cannot see their own email"]:::warn
    KW1 --> KW2["WARNING — Default role = UNKNOWN<br/>No prompt telling user to change it<br/>UNKNOWN is selectable in dropdown"]:::warn
    KW2 --> KW3["WARNING — Mobile: cannot scroll form<br/>On mobile devices, user cannot scroll down<br/>to reach Role dropdown or Save button<br/>Onboarding is blocked on phone"]:::warn
    KW3 --> KW4["WARNING — Wrong button label<br/>Shows 'Save Changes' instead of 'Create Profile'<br/>First-time user creating profile sees edit wording"]:::warn
    KW4 --> L{User action?}:::decision

    L -->|Save Changes| M{Form valid?}:::decision
    L -->|Cancel| N["Cancel → /dashboard/projects"]
    N --> NW["WARNING — No confirmation dialog<br/>Navigates away immediately<br/>Profile not saved, still UNKNOWN role"]:::warn
    NW --> N2["Next visit → redirect loop<br/>Always sent back to Edit User page"]

    M -->|Yes| O{Save API OK?}:::decision
    M -->|No| P["VERIFIED — Inline validation<br/>Shows 'First name is required'<br/>'Last name is required'<br/>via Yup + react-hook-form"]:::done
    P --> P1["Form does not submit<br/>User must fill required fields"]

    O -->|Yes| Q["VERIFIED — Success snackbar<br/>'Update success!'"]:::done
    O -->|No| R["VERIFIED — Error snackbar<br/>'Update Failed!' + error message"]:::done
    R --> R1["User stays on Edit User page<br/>Can retry saving"]

    Q --> S["Page reload → /dashboard/projects"]
    S --> T{Which role<br/>was selected?}:::decision

    T -->|TEACHER| T1["VERIFIED — Projects page + Content sidebar"]:::done
    T1 --> T1E([Onboarding complete]):::endnode

    T -->|STUDENT| T2["Projects page"]
    T2 --> T2W["WARNING — Page mismatch<br/>Sidebar shows 'My Practice'<br/>but landing page is Projects<br/>Should redirect to Assignment List"]:::warn

    T -->|PARENTS| T3["BLOCKED — No functionality at all<br/>Empty sidebar / No pages available"]:::gate
    T3 --> T3W["Dead end: PARENTS role<br/>has no view implemented"]

    T -->|UNKNOWN| T4["BLOCKED — Redirect loop<br/>Always sent back to Edit User page"]:::gate
    T4 --> T4W["Dropdown should not include<br/>UNKNOWN as a selectable option"]

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <!-- ═══════════ FLOW B: Returning User ═══════════ -->
  <h3 class="section-title"><span class="badge">B</span> Returning User</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowB">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowB">
      <pre class="mermaid">
flowchart TD
    A([User opens DAHUA AI]):::start --> B["Login page:<br/><b>Sign in with Google</b>"]
    B --> C[User clicks 'Sign in with Google']
    C --> D[Google picker popup<br/>select account]
    D --> E[Loading screen]
    E --> F{User role?}:::decision

    F -->|ADMIN| FA["Users, School, Content,<br/>Practice, Daily Boost"]
    FA --> FAE([Full Dashboard]):::endnode

    F -->|SCHOOL ROLES| FB["Dashboard, Classroom,<br/>Content, Practice"]
    FB --> FBE([School Dashboard]):::endnode

    F -->|TEACHER| FC["Projects, Question Banks"]
    FC --> FCE([Content only]):::endnode
    FCE --> FCI["No Practice / Assignments<br/>unless Pilot Teacher"]:::info

    F -->|STUDENT| FD["My Practice<br/>Assignment List"]
    FD --> FDE([Student view]):::endnode

    F -->|UNKNOWN| FE["BLOCKED — Empty sidebar<br/>No features visible"]:::gate
    FE --> FEW["Redirect loop: always<br/>sent back to Edit User page"]

    F -->|PARENTS| FF["BLOCKED — Empty sidebar<br/>No features visible"]:::gate
    FF --> FFW["Dead end: no dedicated<br/>parent view exists"]

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <!-- ═══════════ FLOW C: Session Expiry ═══════════ -->
  <h3 class="section-title"><span class="badge">C</span> Session Expiry</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowC">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowC">
      <pre class="mermaid">
flowchart TD
    A([User is idle ~3 min]):::start --> B["Modal popup:<br/>'Your session is about to expire!'"]
    B --> C["Only option: click 'Reload'"]
    C --> W1["WARNING — Cannot dismiss<br/>No close button / No backdrop click"]:::warn
    W1 --> D[Page refreshes, session resumes]
    D --> E([Continue using app]):::endnode

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <footer>DAHUA AI &middot; Flow Diagrams &middot; February 2026</footer>
</div>

<script>
  // ── Mermaid init ──
  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      primaryColor: '#dbeafe',
      primaryTextColor: '#1e40af',
      primaryBorderColor: '#93c5fd',
      lineColor: '#94a3b8',
      secondaryColor: '#fef9c3',
      tertiaryColor: '#f8fafc',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      fontSize: '13px',
      nodeBorder: '#93c5fd',
      mainBkg: '#dbeafe',
      clusterBkg: '#f8fafc',
      clusterBorder: '#e2e8f0',
      edgeLabelBackground: '#ffffff',
    },
    flowchart: {
      htmlLabels: true,
      curve: 'basis',
      padding: 16,
      nodeSpacing: 40,
      rankSpacing: 50,
      useMaxWidth: false,
    },
  });

  // ── Pan & Zoom (custom, no library) ──
  class DiagramPanZoom {
    constructor(viewportId) {
      this.viewport = document.getElementById(viewportId);
      this.scale = 1;
      this.panX = 0;
      this.panY = 0;
      this.minScale = 0.15;
      this.maxScale = 3;
      this.dragging = false;
      this.startX = 0;
      this.startY = 0;
      this.svg = null;
      this.svgW = 0;
      this.svgH = 0;
      this.label = this.viewport.closest('.flow-section').querySelector('[data-label]');
      this._bindEvents();
    }

    init() {
      this.svg = this.viewport.querySelector('svg');
      if (!this.svg) return;
      // Remove mermaid's inline max-width so we control sizing
      this.svg.style.maxWidth = 'none';
      this.svg.removeAttribute('width');
      this.svgW = this.svg.getBoundingClientRect().width;
      this.svgH = this.svg.getBoundingClientRect().height;
      this.fitToView();
    }

    apply() {
      if (!this.svg) return;
      this.svg.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.scale})`;
      this.svg.style.transformOrigin = '0 0';
      if (this.label) this.label.textContent = Math.round(this.scale * 100) + '%';
    }

    fitToView() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      // Re-measure SVG at scale 1
      this.svg.style.transform = 'scale(1)';
      this.svg.style.transformOrigin = '0 0';
      this.svgW = this.svg.scrollWidth;
      this.svgH = this.svg.scrollHeight;

      this.scale = Math.min(vw / this.svgW, vh / this.svgH) * 0.92;
      this.scale = Math.max(this.minScale, Math.min(this.maxScale, this.scale));
      this.panX = (vw - this.svgW * this.scale) / 2;
      this.panY = Math.max((vh - this.svgH * this.scale) / 2, 10);
      this.apply();
    }

    resetZoom() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.scale = 1;
      this.panX = Math.max((vw - this.svgW) / 2, 0);
      this.panY = 10;
      this.apply();
    }

    zoomTo(newScale, cx, cy) {
      // cx, cy = zoom center point relative to viewport
      newScale = Math.max(this.minScale, Math.min(this.maxScale, newScale));
      // Adjust pan so the point under cursor stays in place
      const ratio = newScale / this.scale;
      this.panX = cx - (cx - this.panX) * ratio;
      this.panY = cy - (cy - this.panY) * ratio;
      this.scale = newScale;
      this.apply();
    }

    zoomIn() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.zoomTo(this.scale * 1.25, vw / 2, vh / 2);
    }

    zoomOut() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.zoomTo(this.scale / 1.25, vw / 2, vh / 2);
    }

    _bindEvents() {
      // Mouse wheel zoom
      this.viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = this.viewport.getBoundingClientRect();
        const cx = e.clientX - rect.left;
        const cy = e.clientY - rect.top;
        const factor = e.deltaY < 0 ? 1.12 : 0.88;
        this.zoomTo(this.scale * factor, cx, cy);
      }, { passive: false });

      // Mouse drag to pan
      this.viewport.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        this.dragging = true;
        this.startX = e.clientX - this.panX;
        this.startY = e.clientY - this.panY;
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e) => {
        if (!this.dragging) return;
        this.panX = e.clientX - this.startX;
        this.panY = e.clientY - this.startY;
        this.apply();
      });
      window.addEventListener('mouseup', () => { this.dragging = false; });

      // Touch drag to pan + pinch zoom
      let lastTouchDist = 0;
      let lastTouchMid = { x: 0, y: 0 };
      this.viewport.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          this.dragging = true;
          this.startX = e.touches[0].clientX - this.panX;
          this.startY = e.touches[0].clientY - this.panY;
        } else if (e.touches.length === 2) {
          this.dragging = false;
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          lastTouchDist = Math.sqrt(dx * dx + dy * dy);
          const rect = this.viewport.getBoundingClientRect();
          lastTouchMid = {
            x: (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left,
            y: (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top,
          };
        }
        e.preventDefault();
      }, { passive: false });
      this.viewport.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && this.dragging) {
          this.panX = e.touches[0].clientX - this.startX;
          this.panY = e.touches[0].clientY - this.startY;
          this.apply();
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const factor = dist / lastTouchDist;
          lastTouchDist = dist;
          this.zoomTo(this.scale * factor, lastTouchMid.x, lastTouchMid.y);
        }
        e.preventDefault();
      }, { passive: false });
      this.viewport.addEventListener('touchend', () => { this.dragging = false; });
    }
  }

  // ── Wait for Mermaid to render then init pan/zoom ──
  const diagrams = {};

  function initDiagrams() {
    ['flowA', 'flowB', 'flowC'].forEach((id) => {
      const vp = document.getElementById(id);
      if (!vp || !vp.querySelector('svg')) return;
      const d = new DiagramPanZoom(id);
      d.init();
      diagrams[id] = d;
    });
  }

  // Mermaid renders async; poll until SVGs exist
  let attempts = 0;
  const waitForMermaid = setInterval(() => {
    attempts++;
    const allReady = ['flowA', 'flowB', 'flowC'].every(
      (id) => document.getElementById(id)?.querySelector('svg')
    );
    if (allReady || attempts > 30) {
      clearInterval(waitForMermaid);
      initDiagrams();
    }
  }, 200);

  // Re-fit on window resize
  window.addEventListener('resize', () => {
    Object.values(diagrams).forEach((d) => d.fitToView());
  });

  // ── Toolbar button handlers ──
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.zoom-btn');
    if (!btn) return;
    const toolbar = btn.closest('.zoom-toolbar');
    const id = toolbar?.dataset.for;
    const d = diagrams[id];
    if (!d) return;

    const action = btn.dataset.action;
    if (action === 'in') d.zoomIn();
    else if (action === 'out') d.zoomOut();
    else if (action === 'fit') d.fitToView();
    else if (action === 'reset') d.resetZoom();
  });

  // ── Sidebar toggle ──
  const sidebar = document.getElementById('sidebar');
  document.getElementById('sidebarToggle').addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    const svgEl = document.querySelector('#sidebarToggle svg');
    svgEl.style.transform = sidebar.classList.contains('collapsed') ? 'rotate(180deg)' : '';
    // Keep current zoom/pan — don't reset diagrams
  });
</script>
</body>
</html>
