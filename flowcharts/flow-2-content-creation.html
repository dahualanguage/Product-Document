<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Flow 2 — Content Creation Pipeline</title>
  <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      color: #1e293b; background: #f1f5f9; line-height: 1.5; font-size: 14px;
      display: flex; min-height: 100vh;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: 260px; min-width: 260px; background: #fff;
      border-right: 1px solid #e2e8f0;
      display: flex; flex-direction: column;
      position: fixed; top: 0; left: 0; bottom: 0; z-index: 100;
      transition: width .25s, min-width .25s; overflow: hidden;
    }
    .sidebar.collapsed { width: 48px; min-width: 48px; }
    .sidebar-brand {
      padding: 20px 16px 12px; border-bottom: 1px solid #e2e8f0;
      display: flex; align-items: center; gap: 10px; white-space: nowrap; overflow: hidden;
    }
    .sidebar-brand h2 { font-size: 15px; font-weight: 800; color: #0f172a; transition: opacity .2s; }
    .sidebar.collapsed .sidebar-brand h2 { opacity: 0; pointer-events: none; }
    .sidebar-toggle {
      width: 28px; height: 28px; border-radius: 6px; border: 1px solid #e2e8f0;
      background: #f8fafc; cursor: pointer; display: flex; align-items: center;
      justify-content: center; flex-shrink: 0; color: #64748b;
    }
    .sidebar-toggle:hover { background: #e2e8f0; }
    .sidebar-nav { flex: 1; overflow-y: auto; padding: 8px 0; }
    .nav-item {
      display: flex; align-items: center; gap: 10px; padding: 10px 16px;
      color: #475569; font-size: 13px; font-weight: 600; text-decoration: none;
      border-left: 3px solid transparent; transition: all .15s;
      white-space: nowrap; overflow: hidden;
    }
    .nav-item:hover { background: #f8fafc; color: #1e293b; }
    .nav-item.active { background: #eff6ff; color: #1d4ed8; border-left-color: #3b82f6; }
    .nav-dot {
      width: 24px; height: 24px; border-radius: 6px; display: flex;
      align-items: center; justify-content: center;
      color: #fff; font-weight: 800; font-size: 11px; flex-shrink: 0;
    }
    .nav-label { transition: opacity .2s; }
    .sidebar.collapsed .nav-label { opacity: 0; }

    /* ── Main ── */
    .main { flex: 1; margin-left: 260px; padding: 32px 40px; transition: margin-left .25s; }
    .sidebar.collapsed ~ .main { margin-left: 48px; }
    .page-header { margin-bottom: 28px; }
    .page-header h1 { font-size: 26px; font-weight: 800; color: #0f172a; margin-bottom: 4px; }
    .page-header p { color: #64748b; font-size: 14px; }

    /* ── Flow sections ── */
    .flow-section {
      background: #fff; border: 1px solid #e2e8f0; border-radius: 12px;
      box-shadow: 0 0 2px 0 rgba(145,158,171,.2), 0 12px 24px -4px rgba(145,158,171,.12);
      margin-bottom: 32px; position: relative;
    }
    .section-title {
      font-size: 16px; font-weight: 700; color: #334155; margin: 0 0 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .section-title .badge {
      font-size: 11px; font-weight: 700; color: #fff;
      background: #10b981; padding: 2px 8px; border-radius: 4px;
    }

    /* ── Diagram viewport ── */
    .diagram-viewport {
      width: 100%; height: 620px; overflow: hidden;
      border-radius: 12px; position: relative;
      cursor: grab; background: #fafbfc;
      border-top: 1px solid #f1f5f9;
    }
    .diagram-viewport:active { cursor: grabbing; }
    .diagram-viewport .mermaid {
      transform-origin: 0 0;
      position: absolute; top: 0; left: 0;
    }

    /* ── Zoom toolbar ── */
    .zoom-toolbar {
      position: absolute; top: 12px; right: 12px; z-index: 10;
      display: flex; flex-direction: column; gap: 0;
      background: #fff; border: 1px solid #e2e8f0; border-radius: 10px;
      box-shadow: 0 4px 12px rgba(0,0,0,.08); overflow: hidden;
    }
    .zoom-btn {
      width: 36px; height: 36px; border: none; border-bottom: 1px solid #f1f5f9;
      background: #fff; color: #475569; font-size: 18px; font-weight: 600;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: all .12s; line-height: 1;
    }
    .zoom-btn:last-child { border-bottom: none; }
    .zoom-btn:hover { background: #f1f5f9; color: #1e293b; }
    .zoom-btn:active { background: #e2e8f0; }
    .zoom-btn svg { width: 16px; height: 16px; }
    .zoom-btn.text-btn { font-size: 10px; font-weight: 700; letter-spacing: .3px; }
    .zoom-level {
      width: 36px; height: 28px; display: flex; align-items: center; justify-content: center;
      font-size: 10px; font-weight: 700; color: #94a3b8; user-select: none;
      border-bottom: 1px solid #f1f5f9; background: #f8fafc;
    }

    footer { text-align: center; padding: 24px 0; color: #94a3b8; font-size: 12px; border-top: 1px solid #e2e8f0; margin-top: 20px; }

    @media (max-width: 768px) {
      .sidebar { width: 48px; min-width: 48px; }
      .sidebar .nav-label { opacity: 0; }
      .sidebar .sidebar-brand h2 { opacity: 0; }
      .main { margin-left: 48px; padding: 16px; }
      .diagram-viewport { height: 450px; }
    }
  </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-brand">
    <button class="sidebar-toggle" id="sidebarToggle" title="Toggle sidebar">
      <svg width="16" height="16" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd"/></svg>
    </button>
    <h2>Flow Diagrams</h2>
  </div>
  <nav class="sidebar-nav">
    <a class="nav-item" href="index.html">
      <span class="nav-dot" style="background:#64748b;"><svg width="12" height="12" viewBox="0 0 20 20" fill="#fff"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z"/><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"/></svg></span>
      <span class="nav-label">Legend</span>
    </a>
    <a class="nav-item" href="flow-1-authentication.html">
      <span class="nav-dot" style="background:#6366f1;">1</span>
      <span class="nav-label">Authentication</span>
    </a>
    <a class="nav-item active" href="flow-2-content-creation.html">
      <span class="nav-dot" style="background:#10b981;">2</span>
      <span class="nav-label">Content Creation</span>
    </a>
    <a class="nav-item" href="flow-3-student-practice.html">
      <span class="nav-dot" style="background:#f59e0b;">3</span>
      <span class="nav-label">Student Practice</span>
    </a>
    <a class="nav-item" href="flow-4-school-management.html">
      <span class="nav-dot" style="background:#ef4444;">4</span>
      <span class="nav-label">School Management</span>
    </a>
    <a class="nav-item" href="flow-5-platform-admin.html">
      <span class="nav-dot" style="background:#8b5cf6;">5</span>
      <span class="nav-label">Platform Admin</span>
    </a>
    <a class="nav-item" href="flow-6-live-classroom.html">
      <span class="nav-dot" style="background:#0ea5e9;">6</span>
      <span class="nav-label">Live Classroom</span>
    </a>
  </nav>
</aside>

<div class="main">
  <div class="page-header">
    <h1>2. Content Creation Pipeline</h1>
    <p>Project &rarr; Question Bank &rarr; Practice &rarr; Assignment. Standalone TEACHER can only access Projects &amp; Question Banks unless they are a Pilot Teacher.</p>
  </div>

  <!-- ═══════════ FLOW A: Pipeline Overview & Access ═══════════ -->
  <h3 class="section-title"><span class="badge">A</span> Pipeline Overview &amp; Access Control</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowA">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowA">
      <pre class="mermaid">
flowchart TD
    A([Enter Content section]):::start --> B{User role?}:::decision

    B -->|ADMIN| R1[Full pipeline access<br/>+ Daily Boost sidebar item]
    B -->|SCHOOL_ADMIN /<br/>SCHOOL_TEACHER| R2[Full pipeline access]
    B -->|TEACHER| R3{Pilot Teacher?}:::decision
    B -->|SCHOOL_STUDENT| R4([No content creation access]):::endnode

    R3 -->|Yes| R6[Full pipeline access<br/>via hardcoded email allowlist]
    R3 -->|No| R7[Projects + Question Banks only]
    R7 --> R7W["WARNING — Dead end on New Practice<br/>'You need a school purchase'<br/>Contact email only, no upgrade path"]:::warn
    R6 --> R6W["WARNING — Pilot list hardcoded in source<br/>150+ emails in src/api/pilot-user.js<br/>Requires code deploy to add/remove<br/>All dev pilots expired (30-day window)"]:::warn

    R1 --> STEP1
    R2 --> STEP1
    R6 --> STEP1

    STEP1["Create Project<br/>4-step wizard"] --> STEP2["Generate Question Bank<br/>T/F, Multiple Choice, Q&A"]:::ai
    STEP2 --> STEP3{Practice type?}:::decision
    STEP3 -->|Mirroring| S3M["Mirroring Practice<br/>2-step: Sentences → Audio"]
    STEP3 -->|QA| S3Q["QA Practice<br/>Links to Question Bank"]
    STEP3 -->|Vocabulary| S3V["BLOCKED — Coming Soon<br/>Admin-only preview, disabled for others"]:::gate

    S3M --> PM{processingMode<br/>= FINAL?}:::decision
    PM -->|Yes| STEP4
    PM -->|No| PMW["WARNING — Cannot assign yet<br/>Must click Done in Step 2 first<br/>No visible badge on practice card"]:::warn
    S3Q --> STEP4["Create Assignment"]
    STEP4 --> DIST{School user?}:::decision
    DIST -->|Yes| DY["Assign to Classroom<br/>Select classes, set due dates"]
    DIST -->|No| DN[Share assignment link]
    DY --> DONE([Students receive work]):::endnode
    DN --> DONE

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef ai fill:#ecfdf5,stroke:#6ee7b7,color:#065f46,stroke-width:1.5px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <!-- ═══════════ FLOW B: Project Wizard ═══════════ -->
  <h3 class="section-title"><span class="badge">B</span> Project Wizard (4 Steps)</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowB">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowB">
      <pre class="mermaid">
flowchart TD
    A([Start Project Wizard]):::start --> S1["STEP 1 — Setup<br/>Level Type* / Level* / Target Language*<br/>Native Language (optional)"]
    S1 --> S1V["VERIFIED — Required field validation<br/>Yup schema enforced, LoadingButton on submit"]:::done
    S1 --> S1W["WARNING — Level not reset on type change<br/>Switch CEFR→HSK: old 'B2' value kept<br/>Invalid combo still passes validation"]:::warn

    S1V --> N1{Click Next}:::decision
    N1 -->|Invalid| S1E[Inline validation errors shown]
    N1 -->|Valid| S2

    S2["STEP 2 — AI Generate Content"] --> S2M{Mode?}:::decision
    S2M -->|Create| S2C["AI generates article from topic"]:::ai
    S2M -->|Revise| S2R["AI adapts pasted article to level"]:::ai
    S2M -->|Summary| S2S["AI extracts teaching points"]:::ai
    S2 --> S2W["WARNING — No back button<br/>Cannot return to Step 1<br/>Must refresh browser to go back"]:::warn

    S2C --> S3
    S2R --> S3
    S2S --> S3

    S3["STEP 3 — Edit Content<br/>Project Name* / Article text* (800 chars)"]
    S3 --> S3V["VERIFIED — Credit error shows billing link<br/>Detects validatePaymentAndCreditFailed"]:::done
    S3 --> S3W1["WARNING — Field label says 'Result'<br/>Should say 'Article Content'<br/>Confusing for teachers"]:::warn
    S3 --> S3W2["WARNING — 800-char limit unexplained<br/>Typing silently stops at limit<br/>No warning or guidance shown"]:::warn

    S3 --> N3{Click Next}:::decision
    N3 -->|Has content| S4
    N3 -->|No content| S3H["Next button hidden<br/>until AI generates content"]

    S4["STEP 4 — Confirm Teaching Points<br/>Word selection + Vocabulary cards + Export"]
    S4 --> S4V["VERIFIED — Rich UX<br/>Click-to-select words, inline edit vocab<br/>Soft-delete with restore, unsaved changes bar<br/>Skeleton loading, image polling"]:::done
    S4 --> S4W1["WARNING — Project Name field disabled<br/>No hint, must go back to Step 3 to rename"]:::warn
    S4 --> S4W2["WARNING — Analyze button unclear<br/>Disabled when no words selected<br/>No tooltip explaining why"]:::warn
    S4 --> S4W3["WARNING — No auto-save in wizard<br/>Browser crash = all progress lost"]:::warn
    S4 --> S4W4["WARNING — console.log in production<br/>'handleSplitArticle', 'splitArticleArr'<br/>'vocabError' exposed in browser console"]:::warn
    S4 --> S4W5["WARNING — No breadcrumbs in wizard<br/>No way back to Projects list<br/>Must use sidebar or browser back"]:::warn

    S4 --> COMP["VERIFIED — Completion dialog<br/>3 CTAs: Go to Projects /<br/>Generate Question Bank / Create Practice"]:::done
    COMP --> PL["VERIFIED — Projects List<br/>Card + Table toggle, filter by type<br/>Clone project, pagination, empty state"]:::done
    PL --> PLW["WARNING — Table view delete<br/>has no confirmation dialog<br/>Card view correctly uses confirm dialog<br/>(known TODO in code comments)"]:::warn
    COMP --> END([Wizard complete]):::endnode

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef ai fill:#ecfdf5,stroke:#6ee7b7,color:#065f46,stroke-width:1.5px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <!-- ═══════════ FLOW C: QB → Practice → Assignment ═══════════ -->
  <h3 class="section-title"><span class="badge">C</span> Question Bank → Practice → Assignment</h3>
  <div class="flow-section">
    <div class="zoom-toolbar" data-for="flowC">
      <button class="zoom-btn" data-action="in" title="Zoom in">+</button>
      <button class="zoom-btn" data-action="out" title="Zoom out">&minus;</button>
      <div class="zoom-level" data-label>100%</div>
      <button class="zoom-btn" data-action="fit" title="Fit to view">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
      </button>
      <button class="zoom-btn text-btn" data-action="reset" title="Reset to 100%">1:1</button>
    </div>
    <div class="diagram-viewport" id="flowC">
      <pre class="mermaid">
flowchart TD
    A([Generate Question Bank]):::start --> B["Select source project<br/>Choose question types + count"]
    B --> GEN{Action?}:::decision
    GEN -->|AI Generate| G1["Generates questions asynchronously<br/>Polls requestId until complete"]:::ai
    GEN -->|Manual Add| G2["Inline form with field validation"]
    G1 --> QBR["Question Bank ready<br/>Edit inline / Delete with confirm"]
    G2 --> QBR

    QBR --> QBV["VERIFIED — 3 tabs: T/F, MC, Q&A<br/>Sub-options per type (pinyin, usage, meaning)<br/>Export, unsaved changes bar, subscriber gate"]:::done
    QBR --> QBW1["WARNING — QB and Projects share<br/>same localStorage view mode key<br/>Switching view in one changes the other"]:::warn
    QBR --> QBW2["WARNING — No bulk delete<br/>Must delete questions one by one"]:::warn
    QBR --> QBW3["WARNING — No breadcrumb<br/>when accessing QB from QB list<br/>Only shows when navigating from project"]:::warn

    QBR --> PRC{Create Practice}:::decision
    PRC -->|Mirroring| PM["Mirroring Practice<br/>Step 1: Sentences Review<br/>Step 2: Practice Audio"]
    PRC -->|QA shortcut| PQ["QA Practice<br/>Question bank pre-selected"]
    PRC -->|Vocabulary| PV["BLOCKED — Coming Soon<br/>Disabled for non-admin users"]:::gate

    PM --> PMD{Complete Step 2<br/>and click Done?}:::decision
    PMD -->|Yes| PMF[processingMode = FINAL]
    PMD -->|No| PMI["WARNING — Stuck in INITIAL state<br/>Cannot create assignment<br/>No visible indicator on practice card<br/>Only tooltip on disabled button reveals it"]:::warn

    PQ --> ASN
    PMF --> ASN

    ASN["Create Assignment<br/>(via link icon on Practice card)"]
    ASN --> ASNV["VERIFIED — Inline name editing<br/>Delete with confirmation<br/>Test Assignment preview<br/>NEW badge animation"]:::done
    ASN --> ASNW1["WARNING — No Create Assignment button<br/>on Assignments list page<br/>Must go back to Practice List to create"]:::warn
    ASN --> ASNW2["BLOCKED — Bulk delete is a no-op<br/>handleDeleteRows = empty function<br/>Delete button appears but does nothing"]:::gate
    ASN --> ASNW3["WARNING — N+1 query per practice<br/>Separate API call for each practiceSk<br/>Slow with many assignments"]:::warn

    ASN --> DIST{School user?}:::decision
    DIST -->|Yes| DC["Assign to Classroom<br/>Multi-select classes<br/>Per-class due dates<br/>Previous assignments shown"]
    DIST -->|No| DL[Share link dialog]

    DC --> DCV["VERIFIED — Rich assignment dialog<br/>Quick date buttons (3d / 7d)<br/>Student list, partial success handling"]:::done
    DC --> DCW["WARNING — console.log in production<br/>Class + student data exposed<br/>in browser console"]:::warn

    DL --> DONE([Students receive work]):::endnode
    DC --> DONE

    ASN --> ASNW4["WARNING — window.location used<br/>instead of router.push for navigation<br/>Forces full page reload, loses state"]:::warn
    ASN --> ASNW5["WARNING — Breadcrumb typo<br/>'Practise List' instead of 'Practice List'"]:::warn

    classDef start fill:#e0e7ff,stroke:#a5b4fc,color:#3730a3
    classDef decision fill:#fef9c3,stroke:#fde047,color:#854d0e
    classDef gate fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef warn fill:#fef2f2,stroke:#ef4444,color:#991b1b,stroke-width:2px
    classDef done fill:#f0fdf4,stroke:#86efac,color:#166534,stroke-width:2px
    classDef ai fill:#ecfdf5,stroke:#6ee7b7,color:#065f46,stroke-width:1.5px
    classDef info fill:#f0f9ff,stroke:#bae6fd,color:#0369a1
    classDef endnode fill:#fce7f3,stroke:#f9a8d4,color:#9d174d
      </pre>
    </div>
  </div>

  <footer>DAHUA AI &middot; Flow Diagrams &middot; February 2026</footer>
</div>

<script>
  // ── Mermaid init ──
  mermaid.initialize({
    startOnLoad: true,
    theme: 'base',
    themeVariables: {
      primaryColor: '#dbeafe',
      primaryTextColor: '#1e40af',
      primaryBorderColor: '#93c5fd',
      lineColor: '#94a3b8',
      secondaryColor: '#fef9c3',
      tertiaryColor: '#f8fafc',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
      fontSize: '13px',
      nodeBorder: '#93c5fd',
      mainBkg: '#dbeafe',
      clusterBkg: '#f8fafc',
      clusterBorder: '#e2e8f0',
      edgeLabelBackground: '#ffffff',
    },
    flowchart: {
      htmlLabels: true,
      curve: 'basis',
      padding: 16,
      nodeSpacing: 40,
      rankSpacing: 50,
      useMaxWidth: false,
    },
  });

  // ── Pan & Zoom (custom, no library) ──
  class DiagramPanZoom {
    constructor(viewportId) {
      this.viewport = document.getElementById(viewportId);
      this.scale = 1;
      this.panX = 0;
      this.panY = 0;
      this.minScale = 0.15;
      this.maxScale = 3;
      this.dragging = false;
      this.startX = 0;
      this.startY = 0;
      this.svg = null;
      this.svgW = 0;
      this.svgH = 0;
      this.label = this.viewport.closest('.flow-section').querySelector('[data-label]');
      this._bindEvents();
    }

    init() {
      this.svg = this.viewport.querySelector('svg');
      if (!this.svg) return;
      this.svg.style.maxWidth = 'none';
      this.svg.removeAttribute('width');
      this.svgW = this.svg.getBoundingClientRect().width;
      this.svgH = this.svg.getBoundingClientRect().height;
      this.fitToView();
    }

    apply() {
      if (!this.svg) return;
      this.svg.style.transform = `translate(${this.panX}px, ${this.panY}px) scale(${this.scale})`;
      this.svg.style.transformOrigin = '0 0';
      if (this.label) this.label.textContent = Math.round(this.scale * 100) + '%';
    }

    fitToView() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.svg.style.transform = 'scale(1)';
      this.svg.style.transformOrigin = '0 0';
      this.svgW = this.svg.scrollWidth;
      this.svgH = this.svg.scrollHeight;

      this.scale = Math.min(vw / this.svgW, vh / this.svgH) * 0.92;
      this.scale = Math.max(this.minScale, Math.min(this.maxScale, this.scale));
      this.panX = (vw - this.svgW * this.scale) / 2;
      this.panY = Math.max((vh - this.svgH * this.scale) / 2, 10);
      this.apply();
    }

    resetZoom() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.scale = 1;
      this.panX = Math.max((vw - this.svgW) / 2, 0);
      this.panY = 10;
      this.apply();
    }

    zoomTo(newScale, cx, cy) {
      newScale = Math.max(this.minScale, Math.min(this.maxScale, newScale));
      const ratio = newScale / this.scale;
      this.panX = cx - (cx - this.panX) * ratio;
      this.panY = cy - (cy - this.panY) * ratio;
      this.scale = newScale;
      this.apply();
    }

    zoomIn() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.zoomTo(this.scale * 1.25, vw / 2, vh / 2);
    }

    zoomOut() {
      const vw = this.viewport.clientWidth;
      const vh = this.viewport.clientHeight;
      this.zoomTo(this.scale / 1.25, vw / 2, vh / 2);
    }

    _bindEvents() {
      this.viewport.addEventListener('wheel', (e) => {
        e.preventDefault();
        const rect = this.viewport.getBoundingClientRect();
        const cx = e.clientX - rect.left;
        const cy = e.clientY - rect.top;
        const factor = e.deltaY < 0 ? 1.12 : 0.88;
        this.zoomTo(this.scale * factor, cx, cy);
      }, { passive: false });

      this.viewport.addEventListener('mousedown', (e) => {
        if (e.button !== 0) return;
        this.dragging = true;
        this.startX = e.clientX - this.panX;
        this.startY = e.clientY - this.panY;
        e.preventDefault();
      });
      window.addEventListener('mousemove', (e) => {
        if (!this.dragging) return;
        this.panX = e.clientX - this.startX;
        this.panY = e.clientY - this.startY;
        this.apply();
      });
      window.addEventListener('mouseup', () => { this.dragging = false; });

      let lastTouchDist = 0;
      let lastTouchMid = { x: 0, y: 0 };
      this.viewport.addEventListener('touchstart', (e) => {
        if (e.touches.length === 1) {
          this.dragging = true;
          this.startX = e.touches[0].clientX - this.panX;
          this.startY = e.touches[0].clientY - this.panY;
        } else if (e.touches.length === 2) {
          this.dragging = false;
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          lastTouchDist = Math.sqrt(dx * dx + dy * dy);
          const rect = this.viewport.getBoundingClientRect();
          lastTouchMid = {
            x: (e.touches[0].clientX + e.touches[1].clientX) / 2 - rect.left,
            y: (e.touches[0].clientY + e.touches[1].clientY) / 2 - rect.top,
          };
        }
        e.preventDefault();
      }, { passive: false });
      this.viewport.addEventListener('touchmove', (e) => {
        if (e.touches.length === 1 && this.dragging) {
          this.panX = e.touches[0].clientX - this.startX;
          this.panY = e.touches[0].clientY - this.startY;
          this.apply();
        } else if (e.touches.length === 2) {
          const dx = e.touches[0].clientX - e.touches[1].clientX;
          const dy = e.touches[0].clientY - e.touches[1].clientY;
          const dist = Math.sqrt(dx * dx + dy * dy);
          const factor = dist / lastTouchDist;
          lastTouchDist = dist;
          this.zoomTo(this.scale * factor, lastTouchMid.x, lastTouchMid.y);
        }
        e.preventDefault();
      }, { passive: false });
      this.viewport.addEventListener('touchend', () => { this.dragging = false; });
    }
  }

  // ── Wait for Mermaid to render then init pan/zoom ──
  const diagrams = {};

  function initDiagrams() {
    ['flowA', 'flowB', 'flowC'].forEach((id) => {
      const vp = document.getElementById(id);
      if (!vp || !vp.querySelector('svg')) return;
      const d = new DiagramPanZoom(id);
      d.init();
      diagrams[id] = d;
    });
  }

  let attempts = 0;
  const waitForMermaid = setInterval(() => {
    attempts++;
    const allReady = ['flowA', 'flowB', 'flowC'].every(
      (id) => document.getElementById(id)?.querySelector('svg')
    );
    if (allReady || attempts > 30) {
      clearInterval(waitForMermaid);
      initDiagrams();
    }
  }, 200);

  window.addEventListener('resize', () => {
    Object.values(diagrams).forEach((d) => d.fitToView());
  });

  // ── Toolbar button handlers ──
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.zoom-btn');
    if (!btn) return;
    const toolbar = btn.closest('.zoom-toolbar');
    const id = toolbar?.dataset.for;
    const d = diagrams[id];
    if (!d) return;

    const action = btn.dataset.action;
    if (action === 'in') d.zoomIn();
    else if (action === 'out') d.zoomOut();
    else if (action === 'fit') d.fitToView();
    else if (action === 'reset') d.resetZoom();
  });

  // ── Sidebar toggle ──
  const sidebar = document.getElementById('sidebar');
  document.getElementById('sidebarToggle').addEventListener('click', () => {
    sidebar.classList.toggle('collapsed');
    const svgEl = document.querySelector('#sidebarToggle svg');
    svgEl.style.transform = sidebar.classList.contains('collapsed') ? 'rotate(180deg)' : '';
  });
</script>
</body>
</html>
